import { useEffect, useMemo, useState } from "react";

import {
  DUSUN,
  PRODUK,
  type UmkmKategori,
  type Produk,
  type UmkmInfo,
} from "../data/dummyUmkm";
import { formatRupiah } from "../lib/format";
import { toWaLink } from "../lib/wa";

import Button from "../components/ui/Button";
import Card from "../components/ui/Card";
import Badge from "../components/ui/Badge";
import SearchInput from "../components/ui/SearchInput";
import FilterSelect from "../components/ui/FilterSelect";
import Modal from "../components/ui/Modal";
import Carousel from "../components/ui/Carousel";
import QrCode from "../components/ui/QrCode";

type KategoriOrAll = UmkmKategori | "all";
type QuickFilter = "none" | "cod" | "antar" | "ambil" | "unggulan";

const kategoriUI: { value: KategoriOrAll; label: string }[] = [
  { value: "all", label: "Semua" },
  { value: "makanan", label: "Makanan" },
  { value: "minuman", label: "Minuman" },
  { value: "jasa", label: "Jasa" },
];

function isKategori(v: string): v is UmkmKategori {
  return v === "makanan" || v === "minuman" || v === "jasa";
}

function groupByUmkm(items: Produk[]) {
  const map = new Map<string, { umkm: UmkmInfo; produk: Produk[] }>();
  for (const p of items) {
    const key = p.umkm.id;
    const prev = map.get(key);
    if (!prev) map.set(key, { umkm: p.umkm, produk: [p] });
    else prev.produk.push(p);
  }
  return [...map.values()];
}

function pickUnggulan(umkm: UmkmInfo, produk: Produk[]) {
  const ids = umkm.produk_unggulan_ids ?? [];
  if (ids.length) {
    const picked = produk.filter((p) => ids.includes(p.id));
    return picked.length ? picked.slice(0, 2) : produk.slice(0, 2);
  }
  return produk.slice(0, 2);
}

function scoreUmkm(umkm: UmkmInfo, produk: Produk[]) {
  const unggulan = (umkm.produk_unggulan_ids ?? []).length;
  const layanan = (umkm.layanan ?? []).length;
  const jumlahProduk = produk.length;
  return unggulan * 5 + layanan * 2 + jumlahProduk;
}

function chipClass(active: boolean) {
  return `rounded-full border px-3 py-1 text-xs font-medium transition ${
    active
      ? "border-brand-300 bg-brand-50 text-brand-900"
      : "border-gray-200 bg-white text-gray-700 hover:bg-gray-50"
  }`;
}

export default function ProdukPage() {
  const [dusunId, setDusunId] = useState<string>("all");
  const [kategori, setKategori] = useState<KategoriOrAll>("all");
  const [q, setQ] = useState("");
  const [quick, setQuick] = useState<QuickFilter>("none");

  const [selectedUmkmId, setSelectedUmkmId] = useState<string | null>(null);
  const [selectedProdukId, setSelectedProdukId] = useState<string>("");

  // load more
  const PAGE_SIZE = 8;
  const [visibleCount, setVisibleCount] = useState(PAGE_SIZE);

  const dusunOptions = useMemo(() => {
    return [
      { value: "all", label: "Semua Dusun" },
      ...DUSUN.map((d) => ({ value: d.id, label: d.nama })),
    ];
  }, []);

  const kategoriOptions = useMemo(() => {
    return kategoriUI.map((k) => ({ value: k.value, label: k.label }));
  }, []);

  const filteredProduk = useMemo(() => {
    const query = q.trim().toLowerCase();

    return PRODUK.filter((p) => {
      const okDusun = dusunId === "all" ? true : p.umkm.dusun.id === dusunId;
      const okKat = kategori === "all" ? true : p.umkm.kategori === kategori;
      const hay = `${p.nama} ${p.umkm.nama} ${p.umkm.dusun.nama} ${
        p.deskripsi ?? ""
      }`.toLowerCase();
      const okQ = query === "" ? true : hay.includes(query);
      return okDusun && okKat && okQ;
    });
  }, [dusunId, kategori, q]);

  const filteredUmkmAll = useMemo(() => {
    let grouped = groupByUmkm(filteredProduk);

    if (quick !== "none") {
      grouped = grouped.filter(({ umkm }) => {
        if (quick === "unggulan") return (umkm.produk_unggulan_ids ?? []).length > 0;
        return (umkm.layanan ?? []).includes(quick);
      });
    }

    grouped.sort(
      (a, b) => scoreUmkm(b.umkm, b.produk) - scoreUmkm(a.umkm, a.produk),
    );

    return grouped;
  }, [filteredProduk, quick]);

  const filteredUmkm = useMemo(
    () => filteredUmkmAll.slice(0, visibleCount),
    [filteredUmkmAll, visibleCount],
  );

  const selected = useMemo(() => {
    if (!selectedUmkmId) return null;
    return filteredUmkmAll.find((x) => x.umkm.id === selectedUmkmId) ?? null;
  }, [selectedUmkmId, filteredUmkmAll]);

  useEffect(() => {
    setSelectedProdukId("");
  }, [selectedUmkmId]);

  useEffect(() => {
    setVisibleCount(PAGE_SIZE);
  }, [dusunId, kategori, q, quick]);

  const reset = () => {
    setDusunId("all");
    setKategori("all");
    setQ("");
    setQuick("none");
    setVisibleCount(PAGE_SIZE);
  };

  const onKategoriChange = (v: string) => {
    if (v === "all") return setKategori("all");
    if (isKategori(v)) return setKategori(v);
    return setKategori("all");
  };

  const waText = (umkm: UmkmInfo, produkList: Produk[]) => {
    const chosen = produkList.find((p) => p.id === selectedProdukId);
    if (chosen) {
      return `Halo, saya ingin pesan "${chosen.nama}". Jumlah: __. Alamat: __.`;
    }
    return `Halo, saya ingin tanya/pesan produk dari "${umkm.nama}". Produk: __. Jumlah: __.`;
  };

  return (
    <div className="space-y-6">
      {/* HERO */}
      <div className="rounded-2xl bg-gradient-to-br from-brand-800 to-brand-900 p-6 text-white shadow-soft">
        <div className="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
          <div>
            <h1 className="text-2xl font-semibold">Informasi UMKM</h1>
            <p className="mt-1 text-white/80">
              Pilih UMKM → klik Pesan → WhatsApp terbuka (atau scan QR).
            </p>
          </div>

          <div className="flex flex-wrap items-center gap-2">
            <Badge className="bg-white/15 text-white ring-1 ring-white/20">
              {filteredUmkmAll.length} UMKM
            </Badge>
            <Button variant="secondary" onClick={reset}>
              Reset
            </Button>
          </div>
        </div>
      </div>

      {/* Sticky panel */}
      <div className="sticky top-4 z-10 space-y-3">
        <Card className="p-3">
          <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div className="text-sm font-semibold text-gray-900">Jalur Cepat</div>
            <div className="flex flex-wrap gap-2">
              <button
                type="button"
                className={chipClass(quick === "unggulan")}
                onClick={() => setQuick((v) => (v === "unggulan" ? "none" : "unggulan"))}
              >
                Unggulan
              </button>
              <button
                type="button"
                className={chipClass(quick === "cod")}
                onClick={() => setQuick((v) => (v === "cod" ? "none" : "cod"))}
              >
                Bisa COD
              </button>
              <button
                type="button"
                className={chipClass(quick === "antar")}
                onClick={() => setQuick((v) => (v === "antar" ? "none" : "antar"))}
              >
                Bisa Antar
              </button>
              <button
                type="button"
                className={chipClass(quick === "ambil")}
                onClick={() => setQuick((v) => (v === "ambil" ? "none" : "ambil"))}
              >
                Ambil di tempat
              </button>
            </div>
          </div>
        </Card>

        <Card className="p-4">
          <div className="grid gap-3 md:grid-cols-3">
            <FilterSelect
              label="Dusun"
              value={dusunId}
              options={dusunOptions}
              onChange={setDusunId}
              icon={
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M3 5h18M6 12h12M10 19h4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                </svg>
              }
            />

            <FilterSelect
              label="Kategori"
              value={kategori}
              options={kategoriOptions}
              onChange={onKategoriChange}
              icon={
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M4 7h16M7 12h10M10 17h4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                </svg>
              }
            />

            <SearchInput
              label="Cari"
              placeholder="Nama UMKM / produk..."
              value={q}
              onChange={setQ}
            />
          </div>
        </Card>
      </div>

      {/* LIST UMKM */}
      <div className="space-y-4">
        {filteredUmkm.map(({ umkm, produk }) => {
          const gallery =
            umkm.galeri_foto?.length ? umkm.galeri_foto : produk.map((p) => p.foto_url).slice(0, 3);
          const contoh = pickUnggulan(umkm, produk);

          return (
            <Card key={umkm.id} className="overflow-hidden">
              <div className="grid lg:grid-cols-[280px_1fr]">
                <div className="relative h-48 bg-gray-100 lg:h-full">
                  <Carousel images={gallery} alt={umkm.nama} className="h-full w-full" />
                  <div className="absolute left-3 top-3 flex gap-2">
                    <span className="rounded-full bg-white/90 px-2.5 py-1 text-xs font-semibold text-brand-900 ring-1 ring-black/5 backdrop-blur">
                      {umkm.kategori.toUpperCase()}
                    </span>
                    <span className="rounded-full bg-brand-800 px-2.5 py-1 text-xs font-medium text-white shadow-soft">
                      {umkm.dusun.nama}
                    </span>
                  </div>
                </div>

                <div className="p-5">
                  <div className="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
                    <div className="min-w-0">
                      <div className="text-lg font-semibold text-gray-900">{umkm.nama}</div>
                      <div className="mt-1 text-sm text-gray-600">
                        {umkm.alamat ?? `Dusun ${umkm.dusun.nama}`}
                      </div>

                      <p className="mt-2 text-sm text-gray-700">
                        {umkm.tentang ?? "Deskripsi belum tersedia."}
                      </p>

                      <div className="mt-3 flex flex-wrap gap-2 text-xs text-gray-700">
                        {umkm.jam_buka ? <span className="rounded-full border px-2 py-1">Buka: {umkm.jam_buka}</span> : null}
                        {umkm.layanan?.includes("cod") ? <span className="rounded-full border px-2 py-1">COD</span> : null}
                        {umkm.layanan?.includes("antar") ? <span className="rounded-full border px-2 py-1">Antar</span> : null}
                        {umkm.pembayaran?.length ? (
                          <span className="rounded-full border px-2 py-1">Bayar: {umkm.pembayaran.join(", ")}</span>
                        ) : null}
                        {umkm.estimasi ? <span className="rounded-full border px-2 py-1">Estimasi: {umkm.estimasi}</span> : null}
                      </div>

                      <div className="mt-4">
                        <div className="text-sm font-semibold text-gray-900">Contoh produk</div>
                        <ul className="mt-2 list-disc space-y-1 pl-5 text-sm text-gray-700">
                          {contoh.map((p) => (
                            <li key={p.id}>
                              {p.nama} — {formatRupiah(p.harga)}
                              {p.satuan ? ` / ${p.satuan}` : ""}
                            </li>
                          ))}
                        </ul>
                        <div className="mt-2 text-xs text-gray-500">
                          Klik “Pesan” untuk template WhatsApp & QR.
                        </div>
                      </div>
                    </div>

                    <div className="shrink-0">
                      <button type="button" onClick={() => setSelectedUmkmId(umkm.id)}>
                        <Button className="w-full">Pesan</Button>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </Card>
          );
        })}

        {filteredUmkmAll.length === 0 && (
          <Card className="p-6">
            <div className="font-semibold text-gray-900">Tidak ada UMKM yang cocok.</div>
            <div className="mt-1 text-sm text-gray-600">
              Coba reset filter atau ganti kata kunci.
            </div>
            <div className="mt-4">
              <Button variant="secondary" onClick={reset}>
                Reset
              </Button>
            </div>
          </Card>
        )}

        {filteredUmkmAll.length > filteredUmkm.length ? (
          <div className="flex justify-center">
            <Button variant="secondary" onClick={() => setVisibleCount((v) => v + PAGE_SIZE)}>
              Muat Lagi ({filteredUmkm.length}/{filteredUmkmAll.length})
            </Button>
          </div>
        ) : null}
      </div>

      {/* MODAL UMKM */}
      <Modal
        open={!!selected}
        onClose={() => setSelectedUmkmId(null)}
        title={selected?.umkm.nama}
      >
        {selected ? (
          <div className="space-y-5">
            {/* Gallery */}
            <div className="overflow-hidden rounded-xl border border-gray-200">
              <div className="h-52 bg-gray-100">
                <Carousel
                  images={
                    selected.umkm.galeri_foto?.length
                      ? selected.umkm.galeri_foto
                      : selected.produk.map((p) => p.foto_url)
                  }
                  alt={selected.umkm.nama}
                  className="h-full w-full"
                />
              </div>
            </div>

            {/* Profil ringkas */}
            <div className="space-y-2">
              <div className="text-sm text-gray-600">
                {selected.umkm.alamat ?? `Dusun ${selected.umkm.dusun.nama}`}
              </div>

              <div className="flex flex-wrap gap-2 text-xs text-gray-700">
                <span className="rounded-full border px-2 py-1">{selected.umkm.kategori.toUpperCase()}</span>
                <span className="rounded-full border px-2 py-1">{selected.umkm.dusun.nama}</span>
                {selected.umkm.jam_buka ? <span className="rounded-full border px-2 py-1">Buka: {selected.umkm.jam_buka}</span> : null}
                {selected.umkm.layanan?.includes("cod") ? <span className="rounded-full border px-2 py-1">COD</span> : null}
                {selected.umkm.layanan?.includes("antar") ? <span className="rounded-full border px-2 py-1">Antar</span> : null}
                {selected.umkm.pembayaran?.length ? (
                  <span className="rounded-full border px-2 py-1">Bayar: {selected.umkm.pembayaran.join(", ")}</span>
                ) : null}
              </div>

              {selected.umkm.tentang ? (
                <p className="text-sm text-gray-700">{selected.umkm.tentang}</p>
              ) : null}
            </div>

            {/* PESAN SEKARANG (satu jalur) + QR */}
            <Card className="p-4">
              <div className="flex items-center justify-between gap-3">
                <div>
                  <div className="text-sm font-semibold text-gray-900">Pesan Sekarang</div>
                  <div className="mt-1 text-xs text-gray-600">
                    Pilih produk (opsional) → klik WhatsApp atau scan QR.
                  </div>
                </div>
                <Badge>Fast</Badge>
              </div>

              <div className="mt-4 grid gap-4 lg:grid-cols-[1fr_200px]">
                {/* left */}
                <div className="space-y-3">
                  <div className="rounded-xl border border-gray-200 p-3">
                    <div className="text-xs font-semibold text-gray-600">Pilih produk (opsional)</div>
                    <select
                      className="mt-2 w-full rounded-lg border px-3 py-2 text-sm"
                      value={selectedProdukId}
                      onChange={(e) => setSelectedProdukId(e.target.value)}
                    >
                      <option value="">(Tidak memilih) — tanya dulu</option>
                      {selected.produk.map((p) => (
                        <option key={p.id} value={p.id}>
                          {p.nama} — {formatRupiah(p.harga)}
                        </option>
                      ))}
                    </select>

                    <div className="mt-2 text-xs text-gray-500">
                      Setelah WhatsApp terbuka: isi jumlah + alamat.
                    </div>
                  </div>

                  <div className="flex flex-wrap gap-2">
                    <a
                      href={toWaLink(selected.umkm.no_wa, waText(selected.umkm, selected.produk))}
                      target="_blank"
                      rel="noreferrer"
                    >
                      <Button>Pesan via WhatsApp</Button>
                    </a>

                    {selected.umkm.maps_url ? (
                      <a href={selected.umkm.maps_url} target="_blank" rel="noreferrer">
                        <Button variant="secondary">Lihat Lokasi</Button>
                      </a>
                    ) : null}
                  </div>

                  <div className="text-xs text-gray-500">
                    Jika bingung: klik WhatsApp → tulis “mau pesan produk apa” + jumlah.
                  </div>
                </div>

                {/* right QR */}
                <div className="rounded-xl border border-gray-200 p-3 text-center">
                  <div className="text-xs font-semibold text-gray-600">Scan QR WhatsApp</div>
                  <div className="mt-3 flex justify-center">
                    <QrCode
                      value={toWaLink(selected.umkm.no_wa, waText(selected.umkm, selected.produk))}
                      size={160}
                      className="rounded-lg ring-1 ring-black/5"
                    />
                  </div>
                  <div className="mt-2 text-xs text-gray-500">Lebih cepat saat bazar</div>
                </div>
              </div>
            </Card>

            {/* PRODUK SERUPA (bukan daftar produk internal lagi) */}
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <div className="text-sm font-semibold text-gray-900">Produk Serupa (UMKM lain)</div>
                <Badge>Rekomendasi</Badge>
              </div>

              {(() => {
                const serupa = PRODUK.filter(
                  (p) =>
                    p.umkm.kategori === selected.umkm.kategori &&
                    p.umkm.id !== selected.umkm.id,
                ).slice(0, 6);

                if (!serupa.length) {
                  return (
                    <Card className="p-4">
                      <div className="text-sm text-gray-600">
                        Belum ada rekomendasi produk serupa untuk kategori ini.
                      </div>
                    </Card>
                  );
                }

                return (
                  <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                    {serupa.map((p) => (
                      <Card key={p.id} className="overflow-hidden">
                        <div className="aspect-[4/3] bg-gray-100">
                          <img
                            src={p.foto_url}
                            alt={p.nama}
                            className="h-full w-full object-cover"
                            loading="lazy"
                          />
                        </div>
                        <div className="p-4">
                          <div className="font-semibold text-gray-900">{p.nama}</div>
                          <div className="mt-1 text-xs text-gray-600">
                            {p.umkm.nama} • {p.umkm.dusun.nama}
                          </div>
                          <div className="mt-2 text-sm font-semibold text-brand-900">
                            {formatRupiah(p.harga)}
                            {p.satuan ? <span className="text-gray-500"> / {p.satuan}</span> : null}
                          </div>
                          <div className="mt-3 flex gap-2">
                            <button
                              type="button"
                              onClick={() => {
                                setSelectedUmkmId(p.umkm.id);
                                setSelectedProdukId(p.id);
                              }}
                            >
                              <Button className="px-3 py-2 text-sm">Lihat & Pesan</Button>
                            </button>
                            <a
                              href={toWaLink(p.umkm.no_wa, `Halo, saya ingin pesan "${p.nama}". Jumlah: __. Alamat: __.`)}
                              target="_blank"
                              rel="noreferrer"
                            >
                              <Button variant="secondary" className="px-3 py-2 text-sm">
                                WA
                              </Button>
                            </a>
                          </div>
                        </div>
                      </Card>
                    ))}
                  </div>
                );
              })()}
            </div>
          </div>
        ) : null}
      </Modal>
    </div>
  );
}
